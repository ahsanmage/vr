function autoSaveBilling(){Form.getElements(billing.form).each(function(e){"billing:create_account"==e.id?Event.observe(e,"click",function(e){onMethodChange.bind(this)(e),onBillingChange.bind(this)(e)}):"SELECT"==e.tagName?Event.observe(e,"click",onBillingChange):"INPUT"==e.tagName||"TEXTAREA"==e.tagName,Event.observe(e,"change",onBillingChange)})}function queuedSave(e){"undefined"!=typeof e._queuedSaveInterval&&e._queuedSaveInterval||(e._queuedSaveInterval=setInterval(function(){return checkout.loadWaiting?!0:(clearInterval(e._queuedSaveInterval),e._queuedSaveInterval=!1,e.save(),void 0)},100))}function autoSaveLogin(){$("login:guest")&&$("login:guest").observe("click",onMethodChange),$("login:register")&&$("login:register").observe("click",onMethodChange)}function onMethodChange(){checkout.setMethod()}function onBillingChange(){$("shipping:same_as_billing")&&$("shipping:same_as_billing").checked&&shipping&&shipping.setSameAsBilling(!0);var e=new ValidationEM(billing.form);e.validateSilent()&&queuedSave(billing)}function autoSaveShipping(){"undefined"!=typeof shipping&&Form.getElements(shipping.form).each(function(e){"SELECT"==e.tagName?Event.observe(e,"click",onShippingChange):"INPUT"==e.tagName||"TEXTAREA"==e.tagName,Event.observe(e,"change",onShippingChange)})}function onShippingChange(){if("undefined"!=typeof shipping){var e=new ValidationEM(shipping.form);$("opc-shipping").visible()&&e.validateSilent()&&queuedSave(shipping)}}function autoSaveShippingMethod(){"undefined"!=typeof shippingMethod&&Form.getElements(shippingMethod.form).each(function(e){"undefined"==typeof e._autoSaveShippingMethodBinded&&(e._autoSaveShippingMethodBinded=!0,"SELECT"==e.tagName?Event.observe(e,"click",onShippingMethodChange):"INPUT"==e.tagName||"TEXTAREA"==e.tagName,Event.observe(e,"change",onShippingMethodChange))})}function onShippingMethodChange(){if("undefined"!=typeof shippingMethod){var e=new ValidationEM(shippingMethod.form);shippingMethod.validateSilent()&&e.validateSilent()&&queuedSave(shippingMethod)}}function autoSavePayment(){"undefined"!=typeof payment&&("undefined"!=payment.lastUsedMethod&&onPaymentChange(),Form.getElements(payment.form).each(function(e){"SELECT"==e.tagName?Event.observe(e,"click",onPaymentChange):"INPUT"==e.tagName||"TEXTAREA"==e.tagName,Event.observe(e,"change",onPaymentChange)}))}function onPaymentChange(){if("undefined"!=typeof payment){var e=new ValidationEM(payment.form);payment.validateSilent()&&e.validateSilent()&&queuedSave(payment)}}ValidationEM=Object.extend(Validation,{validateSilent:function(e,t){t=Object.extend({useTitle:!1,onElementValidate:function(){}},t||{}),e=$(e);var i=$w(e.className);return result=i.all(function(i){var n=ValidationEM.testSilent(i,e,t.useTitle);return t.onElementValidate(n,e),n})},testSilent:function(e,t){var i=ValidationEM.get(e);try{return ValidationEM.isVisible(t)&&!i.test($F(t),t)?(this.updateCallback(t,"failed"),!1):(this.updateCallback(t,"passed"),!0)}catch(n){throw n}}}),Object.extend(ValidationEM.prototype,{validateSilent:function(){var e=!1,t=this.options.useTitles,i=this.options.onElementValidate;try{e=Form.getElements(this.form).all(function(e){return e.hasClassName("local-validation")&&!this.isElementInForm(e,this.form)?!0:ValidationEM.validateSilent(e,{useTitle:t,onElementValidate:i})},this)}catch(n){throw n}return this.options.onFormValidate(e,this.form),e}}),function(){var e=Checkout.prototype.setStepResponse,t=Checkout.prototype.initialize,i=Checkout.prototype.setLoadWaiting;Object.extend(Checkout.prototype,{initialize:function(e,i){e={sections:[],openPrevSection:function(){},openNextSection:function(){}},t.bind(this)(e,i),this.onComplete=this.resetLoadWaiting.bindAsEventListener(this)},resetLoadWaiting:function(){checkout.setLoadWaiting(!1)},setStepResponse:function(t){return t.redirect&&(this.loadWaiting=!0),e.bind(this)(t)===!1?!1:(t.update_section&&"shipping-method"==t.update_section.name?autoSaveShippingMethod():t.update_section&&"payment-method"==t.update_section.name&&autoSavePayment(),void 0)},setMethod:function(){if($("billing:create_account")&&!$("billing:create_account").checked){checkout.setLoadWaiting("billing"),this.method="guest";{new Ajax.Request(this.saveMethodUrl,{method:"post",onFailure:this.ajaxFailure.bind(this),onComplete:this.onComplete,parameters:{method:"guest"}})}Element.hide("register-customer-password"),this.gotoSection("billing")}else{checkout.setLoadWaiting("billing"),this.method="register";{new Ajax.Request(this.saveMethodUrl,{method:"post",onFailure:this.ajaxFailure.bind(this),onComplete:this.onComplete,parameters:{method:"register"}})}Element.show("register-customer-password"),this.gotoSection("billing")}document.body.fire("login:setMethod",{method:this.method})},gotoSection:function(e){var t=$("opc-"+e);switch(t.addClassName("allow"),e){case"billing":onBillingChange();break;case"shipping":onShippingChange();break;case"shipping_method":onShippingMethodChange();break;case"payment":onPaymentChange()}},reloadProgressBlock:function(){},setLoadWaiting:function(e,t){return e?($("review-please-wait")._loadwating_innerHTML=$("review-please-wait").innerHTML,$("review-please-wait").innerHTML=$(e+"-please-wait").innerHTML,e="review"):"review"==e&&$("review-please-wait")._loadwating_innerHTML&&($("review-please-wait").innerHTML=$("review-please-wait")._loadwating_innerHTML),i.bind(this)(e,t)},showLoginPopup:function(){$("opc-login-popup-overlay").show(),$("opc-login-popup").show(),$("opc-login-popup").setStyle({left:(parseInt(document.viewport.getWidth())-$("opc-login-popup").getWidth())/2+"px",top:(parseInt(document.viewport.getHeight())-$("opc-login-popup").getHeight())/2+"px"})},hideLoginPopup:function(){$("opc-login-popup-overlay").hide(),$("opc-login-popup").hide()},reloadReviewBlock:function(){new Ajax.Updater("checkout-review-load",this.reviewUrl,{method:"GET",onFailure:this.ajaxFailure.bind(this),evalScripts:!0})}})}(),function(){var _nextStep=Billing.prototype.nextStep;Billing.prototype.nextStep=function(transport){if(_nextStep.bind(this)(transport)===!1)return!1;if(transport&&transport.responseText)try{response=eval("("+transport.responseText+")")}catch(e){response={}}"undefined"==typeof response.update_section&&$("billing:use_for_shipping_no")&&$("billing:use_for_shipping_no").checked&&($("shipping:same_as_billing")&&$("shipping:same_as_billing").checked?onShippingChange():onPaymentChange())}}(),function(){var _nextStep=ShippingMethod.prototype.nextStep;ShippingMethod.prototype.nextStep=function(transport){if(transport&&transport.responseText)try{var response=eval("("+transport.responseText+")")}catch(e){var response={}}response.update_section&&"payment-method"==response.update_section.name&&(payment.validateSilent()?queuedSave(payment):(checkout.reloadReviewBlock(),autoSavePayment())),payment.initWhatIsCvvListeners()},ShippingMethod.prototype.validateSilent=function(){var e=document.getElementsByName("shipping_method");if(0==e.length)return!1;for(var t=0;t<e.length;t++)if(e[t].checked)return!0;return!1}}(),function(){Payment.prototype.validateSilent=function(){var e=this.beforeValidate();if(e)return!0;var t=document.getElementsByName("payment[method]");if(0==t.length)return!1;for(var i=0;i<t.length;i++)if(t[i].checked)return!0;return e=this.afterValidate(),e?!0:!1},Payment.prototype.save=function(){if(0==checkout.loadWaiting){var e=new Validation(this.form);if(this.validate()&&e.validate()){checkout.setLoadWaiting("payment");{new Ajax.Request(this.saveUrl,{method:"post",asynchronous:!1,onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout),parameters:Form.serialize(this.form)})}}}},Payment.prototype.nextStep=function(transport){if(transport&&transport.responseText)try{response=eval("("+transport.responseText+")")}catch(e){response={}}if(response.redirect)return this.redirect=response.redirect,void 0;if(response.error){if(response.fields){for(var fields=response.fields.split(","),i=0;i<fields.length;i++){var field=null;(field=$(fields[i]))&&Validation.ajaxError(field,response.error)}return}return alert(response.error),void 0}checkout.reloadReviewBlock()}}(),function(){Review.prototype.save=function(){var e=new ValidationEM(payment.form),t=new ValidationEM(billing.form);if(t.validate()&&payment.validate()&&e.validate()){if(payment.redirect)return location.href=payment.redirect,void 0;if(0!=checkout.loadWaiting)return;checkout.setLoadWaiting("review");var i=Form.serialize(payment.form);this.agreementsForm&&(i+="&"+Form.serialize(this.agreementsForm)),i.save=!0;{new Ajax.Request(this.saveUrl,{method:"post",parameters:i,onComplete:this.onComplete,onSuccess:this.onSave,onFailure:checkout.ajaxFailure.bind(checkout)})}}}}(),Event.observe(window,"load",function(){$("opc-login-popup")&&(document.body.appendChild($("opc-login-popup")),document.body.appendChild($("opc-login-popup-overlay")),Event.observe(window,"resize",function(){$("opc-login-popup").visible()&&$("opc-login-popup").setStyle({left:(parseInt(document.viewport.getWidth())-$("opc-login-popup").getWidth())/2+"px",top:(parseInt(document.viewport.getHeight())-$("opc-login-popup").getHeight())/2+"px"})})),$("billing:use_for_shipping_yes")&&($("billing:use_for_shipping_yes").observe("click",function(){$("opc-shipping").hide()}),$("billing:use_for_shipping_yes").checked&&$("opc-shipping").hide()),$("billing:use_for_shipping_no")&&($("billing:use_for_shipping_no").observe("click",function(){$("opc-shipping").show()}),$("billing:use_for_shipping_no").checked&&$("opc-shipping").show()),$("shipping:same_as_billing")&&$("shipping:same_as_billing").observe("click",function(){this.checked?$("billing:use_for_shipping_yes")&&($("billing:use_for_shipping_yes").checked=!0):$("billing:use_for_shipping_no")&&($("billing:use_for_shipping_no").checked=!0)}),autoSaveLogin(),autoSaveBilling(),autoSaveShipping(),autoSaveShippingMethod(),autoSavePayment(),$("billing:create_account")&&onMethodChange(),"undefined"!=typeof shipping&&$("opc-shipping").visible()?onShippingChange():onBillingChange(),payment.initWhatIsCvvListeners()});