String.prototype.getQueryString=function(){var e=this.split("?");return"undefined"==typeof e[1]?"":e[1]};var EM_LayeredNavigation=Class.create();EM_LayeredNavigation.prototype={initialize:function(e){this.endpoint=e.endpoint,this.category=e.category,this.enableAjax=e.ajax,this.layer=".block-layered-nav",this.products=".category-products",this.selectors=[this.layer+" a",this.layer+" input",this.layer+" select",this.products+" .view-mode a",this.products+" .sort-by a",this.products+" .limiter select",this.products+" .sort-by select",this.products+" .pages a"],this.tagcompare=this.products+" .add-to-links a.link-compare",this.setupState(e.reqUri),this.setupEvent(),this.currLayout=e.current_layout},setupEvent:function(){var e=this;$$(this.selectors.join(",")).each(function(t){switch(t.tagName){case"A":t.href=e.replaceUrl(t.href),$(t).observe("click",function(t){t.preventDefault(),e.update(this.href)});break;case"SELECT":$(t).select("option").each(function(t){t.value=e.replaceUrl(t.value)}),t.onchange=function(){e.update(this.value)};break;case"INPUT":t.value=e.replaceUrl(t.value),$(t).observe("click",function(){e.update(this.value)})}})},replaceUrl:function(e){var t=e.getQueryString(),r=document.URL.replace(/\?.*/,"");return r+"?"+t},update:function(e){var t=this.endpoint+"id/"+this.category+"/",r=t,a=e.getQueryString();if(""!=a&&(r+="?"+a),!this.enableAjax)return window.location=e,void 0;$("loading-mask").show();var i=this;new Ajax.Request(r,{parameters:"curr="+this.currLayout,onSuccess:function(e){var t=e.responseJSON;$$('meta[name="robots"]').first().setAttribute("content",t.robots),i.prepareBlock(),0!=$$(".block-layered-nav").length&&$$(i.layer).first().replace(t.layer),$$(i.products).first().replace(t.products),t.cat_title&&$$(".category-title").length>0&&($$(".category-title").first().innerHTML="<h1>"+t.cat_title+"</h1>"),t.breadcrumbs&&$$(".breadcrumbs").length>0&&$$(".breadcrumbs").first().replace(t.breadcrumbs),t.cat_desc&&$$(".category-description").length>0&&($$(".category-description").first().innerHTML=t.cat_desc),i.setState(a),i.prevQuery=a,i.setupEvent(),setTimeout(function(){window.afterLayerUpdate()},1e3),setTimeout(function(){$("loading-mask").hide()},1500)}})},setupState:function(e){if(!jQuery.browser.msie){var t=e.split("?"),r=t[0];this.prevQuery="undefined"!=typeof t[1]?t[1]:"",jQuery.address.state(r),jQuery.address.externalChange(this.onStateChange.bind(this))}},setState:function(e){jQuery.browser.msie||jQuery.address.queryString(e)},onStateChange:function(e){if(e.queryString!=this.prevQuery){var t=e.queryString;jQuery.address.queryString(t),this.update("?"+t)}},prepareBlock:function(){if(!$$(this.products).length||0!=$$(".block-layered-nav").length){var e=this.products.replace(".","");$$(".em-col-main").first().insert({bottom:'<div class="'+e+'"></div>'}),$$(".note-msg").each(function(e){e.remove()})}}};